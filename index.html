<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Identifikatsiya Tizimi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .input-focus:focus {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .oval-frame {
            width: 300px;
            height: 400px;
            border: 4px solid #10b981;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
        }
        .oval-frame.detecting {
            border-color: #f59e0b;
            animation: pulse 1s infinite;
        }
        .oval-frame.valid {
            border-color: #10b981;
            animation: validPulse 0.5s ease-out;
        }
        .oval-frame.invalid {
            border-color: #ef4444;
            animation: shake 0.5s ease-out;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.02); opacity: 0.8; }
        }
        @keyframes validPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .status-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            min-width: 250px;
        }
        .notification {
            animation: slideInRight 0.3s ease-out;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .error-field {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 1px #ef4444 !important;
        }
        .fullscreen-camera {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .face-detection-info {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            min-width: 300px;
        }
        .progress-bar {
            width: 200px;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px auto;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #34d399);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <!-- Status Panel -->
    <div id="statusPanel" class="status-panel">
        <!-- Notifications will appear here -->
    </div>

    <!-- Fullscreen Camera Modal -->
    <div id="fullscreenCamera" class="fullscreen-camera hidden">
        <div class="face-detection-info">
            <h3 class="text-lg font-semibold mb-2" id="detectionTitle">Yuz tanish</h3>
            <p class="text-sm mb-3" id="detectionMessage">Yuzingizni oval ichiga joylashtiring</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p class="text-xs text-gray-300" id="detectionStatus">Jonli yuz kutilmoqda...</p>
        </div>
        
        <div class="relative">
            <video id="fullscreenVideo" class="rounded-2xl" width="640" height="480" autoplay muted></video>
            <div class="absolute inset-0 flex items-center justify-center">
                <div class="oval-frame" id="faceFrame"></div>
            </div>
        </div>
        
        <button onclick="closeFaceDetection()" class="mt-6 bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300">
            Bekor qilish
        </button>
    </div>

    <div class="w-full max-w-md">
        <!-- Kirish Oynasi -->
        <div id="loginForm" class="glass-effect rounded-2xl p-8 shadow-2xl slide-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">Xush kelibsiz</h2>
                <p class="text-white/80">Hisobingizga kiring</p>
            </div>

            <form class="space-y-6">
                <div>
                    <label class="block text-white/90 text-sm font-medium mb-2">Email yoki telefon</label>
                    <input type="text" id="loginEmail" class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 input-focus transition-all duration-300" placeholder="email@example.com">
                </div>
                
                <div>
                    <label class="block text-white/90 text-sm font-medium mb-2">Parol</label>
                    <div class="relative">
                        <input type="password" id="loginPassword" class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 input-focus transition-all duration-300" placeholder="••••••••">
                        <button type="button" onclick="togglePassword('loginPassword')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-white/60 hover:text-white transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <label class="flex items-center">
                        <input type="checkbox" class="w-4 h-4 text-indigo-600 bg-white/20 border-white/30 rounded focus:ring-white/50">
                        <span class="ml-2 text-white/80 text-sm">Eslab qolish</span>
                    </label>
                    <button type="button" class="text-white/80 hover:text-white text-sm transition-colors">Parolni unutdingizmi?</button>
                </div>

                <button type="button" onclick="performLogin()" class="w-full bg-white text-indigo-600 py-3 px-4 rounded-xl font-semibold hover:bg-white/90 transform hover:scale-105 transition-all duration-300 shadow-lg">
                    Kirish
                </button>
            </form>

            <div class="mt-6">
                <div class="relative">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-white/30"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-transparent text-white/80">yoki</span>
                    </div>
                </div>

                <button type="button" onclick="startFaceLogin()" id="faceLoginBtn" class="w-full mt-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 px-4 rounded-xl font-semibold hover:from-purple-600 hover:to-pink-600 transform hover:scale-105 transition-all duration-300 shadow-lg flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                    <span>Yuz orqali kirish</span>
                </button>
            </div>

            <div class="mt-6 text-center">
                <p class="text-white/80">Hisobingiz yo'qmi? 
                    <button onclick="showRegister()" class="text-white font-semibold hover:underline">Ro'yxatdan o'ting</button>
                </p>
            </div>
        </div>

        <!-- Ro'yxatdan o'tish oynasi -->
        <div id="registerForm" class="glass-effect rounded-2xl p-8 shadow-2xl slide-in hidden">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">Ro'yxatdan o'tish</h2>
                <p class="text-white/80">Yangi hisob yarating</p>
            </div>

            <form class="space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-white/90 text-sm font-medium mb-2">Ism</label>
                        <input type="text" id="firstName" class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 input-focus transition-all duration-300" placeholder="Ismingiz">
                    </div>
                    <div>
                        <label class="block text-white/90 text-sm font-medium mb-2">Familiya</label>
                        <input type="text" id="lastName" class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 input-focus transition-all duration-300" placeholder="Familiyangiz">
                    </div>
                </div>

                <div>
                    <label class="block text-white/90 text-sm font-medium mb-2">Email</label>
                    <input type="email" id="registerEmail" class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 input-focus transition-all duration-300" placeholder="email@example.com">
                </div>

                <div>
                    <label class="block text-white/90 text-sm font-medium mb-2">Telefon raqam</label>
                    <input type="tel" id="phone" class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 input-focus transition-all duration-300" placeholder="+998 90 123 45 67">
                </div>

                <div>
                    <label class="block text-white/90 text-sm font-medium mb-2">Parol</label>
                    <div class="relative">
                        <input type="password" id="registerPassword" class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 input-focus transition-all duration-300" placeholder="••••••••">
                        <button type="button" onclick="togglePassword('registerPassword')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-white/60 hover:text-white transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-white/90 text-sm font-medium mb-2">Parolni tasdiqlang</label>
                    <div class="relative">
                        <input type="password" id="confirmPassword" class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 input-focus transition-all duration-300" placeholder="••••••••">
                        <button type="button" onclick="togglePassword('confirmPassword')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-white/60 hover:text-white transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="flex items-center">
                    <input type="checkbox" id="terms" class="w-4 h-4 text-indigo-600 bg-white/20 border-white/30 rounded focus:ring-white/50">
                    <label for="terms" class="ml-2 text-white/80 text-sm">
                        <span>Men </span>
                        <button type="button" class="text-white font-semibold hover:underline">foydalanish shartlari</button>
                        <span> va </span>
                        <button type="button" class="text-white font-semibold hover:underline">maxfiylik siyosati</button>
                        <span>ga roziman</span>
                    </label>
                </div>

                <button type="button" onclick="performRegister()" class="w-full bg-white text-indigo-600 py-3 px-4 rounded-xl font-semibold hover:bg-white/90 transform hover:scale-105 transition-all duration-300 shadow-lg">
                    Ro'yxatdan o'tish
                </button>
            </form>

            <div class="mt-6">
                <div class="relative">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-white/30"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-transparent text-white/80">yoki</span>
                    </div>
                </div>

                <button type="button" onclick="startFaceRegistration()" id="faceRegisterBtn" class="w-full mt-4 bg-gradient-to-r from-green-500 to-teal-500 text-white py-3 px-4 rounded-xl font-semibold hover:from-green-600 hover:to-teal-600 transform hover:scale-105 transition-all duration-300 shadow-lg flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <span>Yuz orqali ro'yxatdan o'tish</span>
                </button>
            </div>

            <div class="mt-6 text-center">
                <p class="text-white/80">Hisobingiz bormi? 
                    <button onclick="showLogin()" class="text-white font-semibold hover:underline">Kirish</button>
                </p>
            </div>
        </div>

        <!-- Muvaffaqiyat oynasi -->
        <div id="successForm" class="glass-effect rounded-2xl p-8 shadow-2xl slide-in hidden">
            <div class="text-center">
                <div class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-white mb-4">Muvaffaqiyatli!</h2>
                <p class="text-white/80 mb-8" id="successMessage">Hisobingiz muvaffaqiyatli yaratildi</p>
                
                <button onclick="showLogin()" class="w-full bg-white text-indigo-600 py-3 px-4 rounded-xl font-semibold hover:bg-white/90 transform hover:scale-105 transition-all duration-300 shadow-lg">
                    Hisobga kirish
                </button>
            </div>
        </div>
    </div>

    <script>
        let registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
        let currentStream = null;
        let faceDetectionInterval = null;
        let detectionProgress = 0;
        let isProcessing = false;
        let currentMode = 'register'; // 'register' or 'login'
        
        // Ovoz effektlari
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(frequency, duration, type = 'success') {
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                if (type === 'success') {
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
                } else if (type === 'error') {
                    oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(300, audioContext.currentTime + 0.1);
                } else {
                    oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                }
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log('Audio not supported');
            }
        }
        
        // Qurilma tekshirish
        function isMobileDevice() {
            const userAgent = navigator.userAgent.toLowerCase();
            const isAndroid = userAgent.includes('android');
            const isIOS = userAgent.includes('iphone') || userAgent.includes('ipad') || userAgent.includes('ipod');
            return isAndroid || isIOS;
        }
        
        // Bildirishnoma ko'rsatish
        function showNotification(message, type = 'info', duration = 3000) {
            const panel = document.getElementById('statusPanel');
            const notification = document.createElement('div');
            
            let bgColor = 'bg-blue-500';
            let icon = '🔔';
            
            if (type === 'success') {
                bgColor = 'bg-green-500';
                icon = '✅';
                playSound(800, 0.2, 'success');
            } else if (type === 'error') {
                bgColor = 'bg-red-500';
                icon = '❌';
                playSound(400, 0.3, 'error');
            } else if (type === 'warning') {
                bgColor = 'bg-yellow-500';
                icon = '⚠️';
                playSound(600, 0.2, 'warning');
            }
            
            notification.className = `notification ${bgColor} text-white p-3 rounded-lg mb-2 shadow-lg flex items-center space-x-2`;
            notification.innerHTML = `
                <span class="text-lg">${icon}</span>
                <span class="text-sm">${message}</span>
            `;
            
            panel.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, duration);
        }
        
        // Maydon xatoligini ko'rsatish
        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            field.classList.add('error-field');
            showNotification(message, 'error');
            
            setTimeout(() => {
                field.classList.remove('error-field');
            }, 3000);
        }

        function showLogin() {
            hideAllForms();
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('loginForm').classList.add('fade-in');
        }

        function showRegister() {
            hideAllForms();
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('fade-in');
        }

        function showSuccess(message = 'Hisobingiz muvaffaqiyatli yaratildi') {
            hideAllForms();
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successForm').classList.remove('hidden');
            document.getElementById('successForm').classList.add('fade-in');
        }

        function hideAllForms() {
            const forms = ['loginForm', 'registerForm', 'successForm'];
            forms.forEach(formId => {
                document.getElementById(formId).classList.add('hidden');
                document.getElementById(formId).classList.remove('fade-in');
            });
            
            closeFaceDetection();
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function performLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showNotification('Barcha maydonlarni to\'ldiring!', 'error');
                return;
            }
            
            // Foydalanuvchini tekshirish
            const user = registeredUsers.find(u => 
                (u.email === email || u.phone === email) && u.password === password
            );
            
            if (user) {
                showNotification(`Xush kelibsiz, ${user.firstName}!`, 'success');
                setTimeout(() => {
                    showSuccess(`Tizimga muvaffaqiyatli kirildi!\nXush kelibsiz, ${user.firstName} ${user.lastName}`);
                }, 1000);
            } else {
                showNotification('Email/telefon yoki parol noto\'g\'ri!', 'error');
            }
        }

        function performRegister() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const terms = document.getElementById('terms').checked;
            
            // Validatsiya
            if (!firstName) {
                showFieldError('firstName', 'Ism kiritilishi shart!');
                return;
            }
            
            if (!lastName) {
                showFieldError('lastName', 'Familiya kiritilishi shart!');
                return;
            }
            
            if (!email) {
                showFieldError('registerEmail', 'Email kiritilishi shart!');
                return;
            }
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showFieldError('registerEmail', 'Email formati noto\'g\'ri!');
                return;
            }
            
            if (!phone) {
                showFieldError('phone', 'Telefon raqam kiritilishi shart!');
                return;
            }
            
            if (!password) {
                showFieldError('registerPassword', 'Parol kiritilishi shart!');
                return;
            }
            
            if (password.length < 6) {
                showFieldError('registerPassword', 'Parol kamida 6 ta belgidan iborat bo\'lishi kerak!');
                return;
            }
            
            if (!confirmPassword) {
                showFieldError('confirmPassword', 'Parolni tasdiqlash shart!');
                return;
            }
            
            if (password !== confirmPassword) {
                showFieldError('confirmPassword', 'Parollar mos kelmaydi!');
                return;
            }
            
            if (!terms) {
                showNotification('Foydalanish shartlarini qabul qiling!', 'error');
                return;
            }
            
            // Email/telefon takrorlanishini tekshirish
            const existingUser = registeredUsers.find(u => u.email === email || u.phone === phone);
            if (existingUser) {
                showNotification('Bu email yoki telefon raqam allaqachon ro\'yxatdan o\'tgan!', 'error');
                return;
            }
            
            // Foydalanuvchini ro'yxatga qo'shish
            const newUser = {
                id: Date.now(),
                firstName,
                lastName,
                email,
                phone,
                password,
                registeredAt: new Date().toISOString(),
                hasFaceData: false,
                faceData: null
            };
            
            registeredUsers.push(newUser);
            localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
            
            showNotification('Ma\'lumotlar saqlandi!', 'success');
            showSuccess('Ro\'yxatdan o\'tish muvaffaqiyatli yakunlandi!');
        }

        // Yuz ro'yxatga olish
        function startFaceRegistration() {
            if (!isMobileDevice()) {
                showNotification('Yuz tanish faqat Android va iOS qurilmalarda ishlaydi!', 'error');
                return;
            }
            
            currentMode = 'register';
            openFaceDetection('Yuz ro\'yxatga olish', 'Yuzingizni oval ichiga joylashtiring va harakatsiz turing');
        }

        // Yuz orqali kirish
        function startFaceLogin() {
            if (!isMobileDevice()) {
                showNotification('Yuz tanish faqat Android va iOS qurilmalarda ishlaydi!', 'error');
                return;
            }
            
            // Ro'yxatdan o'tgan foydalanuvchilar borligini tekshirish
            const usersWithFace = registeredUsers.filter(user => user.hasFaceData);
            if (usersWithFace.length === 0) {
                showNotification('Hech kim yuz orqali ro\'yxatdan o\'tmagan! Avval yuz orqali ro\'yxatdan o\'ting.', 'warning');
                return;
            }
            
            currentMode = 'login';
            openFaceDetection('Yuz orqali kirish', 'Ro\'yxatdan o\'tgan yuzingizni tanish uchun oval ichiga qarang');
        }

        async function openFaceDetection(title, message) {
            try {
                document.getElementById('detectionTitle').textContent = title;
                document.getElementById('detectionMessage').textContent = message;
                document.getElementById('fullscreenCamera').classList.remove('hidden');
                
                showNotification('Kamera yoqilmoqda...', 'info');
                
                currentStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 }, 
                        height: { ideal: 720 },
                        facingMode: 'user'
                    } 
                });
                
                const video = document.getElementById('fullscreenVideo');
                video.srcObject = currentStream;
                
                video.onloadedmetadata = () => {
                    video.play();
                    showNotification('Kamera yoqildi! Yuzingizni oval ichiga joylashtiring.', 'success');
                    startFaceDetection();
                };
                
            } catch (error) {
                console.error('Kamera xatosi:', error);
                showNotification('Kameraga kirish rad etildi!', 'error');
                closeFaceDetection();
            }
        }

        function closeFaceDetection() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            if (faceDetectionInterval) {
                clearInterval(faceDetectionInterval);
                faceDetectionInterval = null;
            }
            
            document.getElementById('fullscreenCamera').classList.add('hidden');
            detectionProgress = 0;
            isProcessing = false;
            
            // Progress bar reset
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('faceFrame').className = 'oval-frame';
        }

        function startFaceDetection() {
            const video = document.getElementById('fullscreenVideo');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const faceFrame = document.getElementById('faceFrame');
            const statusElement = document.getElementById('detectionStatus');
            const progressFill = document.getElementById('progressFill');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            faceDetectionInterval = setInterval(() => {
                if (isProcessing) return;
                
                // Jonli yuz tekshirish simulatsiyasi
                ctx.drawImage(video, 0, 0);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // Yuz mavjudligini tekshirish (soddalashtirilgan)
                const brightness = calculateBrightness(imageData);
                const hasMovement = detectMovement(imageData);
                const faceInFrame = detectFaceInFrame(imageData);
                
                if (brightness < 50) {
                    // Juda qorong'u
                    faceFrame.className = 'oval-frame invalid';
                    statusElement.textContent = 'Yoritish yetarli emas, yorug\'roq joyga o\'ting';
                    resetProgress();
                } else if (!faceInFrame) {
                    // Yuz topilmadi
                    faceFrame.className = 'oval-frame invalid';
                    statusElement.textContent = 'Yuz aniqlanmadi, oval ichiga qarang';
                    resetProgress();
                } else if (!hasMovement) {
                    // Harakatsiz (rasm bo'lishi mumkin)
                    faceFrame.className = 'oval-frame invalid';
                    statusElement.textContent = 'Jonli yuz aniqlanmadi, ko\'z qirping yoki bosh harakati qiling';
                    resetProgress();
                } else {
                    // Barcha shartlar bajarildi
                    faceFrame.className = 'oval-frame detecting';
                    statusElement.textContent = 'Jonli yuz aniqlandi, tekshirilmoqda...';
                    
                    detectionProgress += 10;
                    progressFill.style.width = `${Math.min(detectionProgress, 100)}%`;
                    
                    if (detectionProgress >= 100) {
                        // 3 soniya to'ldi
                        faceFrame.className = 'oval-frame valid';
                        statusElement.textContent = 'Muvaffaqiyatli! Qayta ishlanmoqda...';
                        isProcessing = true;
                        
                        setTimeout(() => {
                            processFaceData(canvas);
                        }, 500);
                    }
                }
            }, 300); // Har 300ms da tekshirish
        }

        function calculateBrightness(imageData) {
            let totalBrightness = 0;
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                totalBrightness += (r + g + b) / 3;
            }
            
            return totalBrightness / (data.length / 4);
        }

        let previousImageData = null;
        function detectMovement(imageData) {
            if (!previousImageData) {
                previousImageData = imageData;
                return false;
            }
            
            let diff = 0;
            const data = imageData.data;
            const prevData = previousImageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const currentPixel = (data[i] + data[i + 1] + data[i + 2]) / 3;
                const prevPixel = (prevData[i] + prevData[i + 1] + prevData[i + 2]) / 3;
                diff += Math.abs(currentPixel - prevPixel);
            }
            
            previousImageData = imageData;
            return diff > 1000; // Harakat chegarasi
        }

        function detectFaceInFrame(imageData) {
            // Soddalashtirilgan yuz aniqlash
            // Haqiqiy dasturda face-api.js yoki boshqa kutubxona ishlatiladi
            const data = imageData.data;
            const width = imageData.width;
            const height = imageData.height;
            
            // Markaziy qismda yuz rangidagi piksellarni qidirish
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) / 6;
            
            let skinPixels = 0;
            let totalPixels = 0;
            
            for (let y = centerY - radius; y < centerY + radius; y++) {
                for (let x = centerX - radius; x < centerX + radius; x++) {
                    if (x >= 0 && x < width && y >= 0 && y < height) {
                        const index = (y * width + x) * 4;
                        const r = data[index];
                        const g = data[index + 1];
                        const b = data[index + 2];
                        
                        // Teri rangini aniqlash (soddalashtirilgan)
                        if (r > 95 && g > 40 && b > 20 && 
                            Math.max(r, g, b) - Math.min(r, g, b) > 15 &&
                            Math.abs(r - g) > 15 && r > g && r > b) {
                            skinPixels++;
                        }
                        totalPixels++;
                    }
                }
            }
            
            return (skinPixels / totalPixels) > 0.3; // 30% dan ko'p teri rangi
        }

        function resetProgress() {
            detectionProgress = Math.max(0, detectionProgress - 5);
            document.getElementById('progressFill').style.width = `${detectionProgress}%`;
        }

        function processFaceData(canvas) {
            const faceData = canvas.toDataURL();
            
            if (currentMode === 'register') {
                // Ro'yxatga olish
                showNotification('Yuz ma\'lumotlari saqlanmoqda...', 'info');
                
                setTimeout(() => {
                    // Yangi foydalanuvchi yaratish
                    const newUser = {
                        id: Date.now(),
                        firstName: 'Yuz orqali',
                        lastName: 'Ro\'yxatdan o\'tgan',
                        email: `face_user_${Date.now()}@system.local`,
                        phone: `+998${Math.floor(Math.random() * 1000000000)}`,
                        password: 'face_auth_' + Date.now(),
                        registeredAt: new Date().toISOString(),
                        hasFaceData: true,
                        faceData: faceData
                    };
                    
                    registeredUsers.push(newUser);
                    localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
                    
                    closeFaceDetection();
                    showNotification('Yuz orqali ro\'yxatdan o\'tish muvaffaqiyatli!', 'success');
                    showSuccess('Yuz orqali ro\'yxatdan o\'tish muvaffaqiyatli yakunlandi!');
                }, 1000);
                
            } else {
                // Kirish
                showNotification('Yuz tanilmoqda...', 'info');
                
                setTimeout(() => {
                    // Yuzni solishtirish (demo maqsadida har doim muvaffaqiyatli)
                    const usersWithFace = registeredUsers.filter(user => user.hasFaceData);
                    
                    if (usersWithFace.length > 0) {
                        const recognizedUser = usersWithFace[0]; // Birinchi foydalanuvchini tanish
                        
                        closeFaceDetection();
                        showNotification(`Xush kelibsiz, ${recognizedUser.firstName}!`, 'success');
                        showSuccess(`Yuz orqali tizimga muvaffaqiyatli kirildi!\nXush kelibsiz, ${recognizedUser.firstName} ${recognizedUser.lastName}`);
                    } else {
                        closeFaceDetection();
                        showNotification('Yuz tanilmadi!', 'error');
                    }
                }, 1000);
            }
        }

        // Sahifa yuklanganda
        document.addEventListener('DOMContentLoaded', function() {
            // Mobil qurilma emasligini tekshirish
            if (!isMobileDevice()) {
                const faceLoginBtn = document.getElementById('faceLoginBtn');
                const faceRegisterBtn = document.getElementById('faceRegisterBtn');
                
                if (faceLoginBtn) {
                    faceLoginBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    faceLoginBtn.title = 'Faqat Android va iOS qurilmalarda ishlaydi';
                }
                
                if (faceRegisterBtn) {
                    faceRegisterBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    faceRegisterBtn.title = 'Faqat Android va iOS qurilmalarda ishlaydi';
                }
            }
            
            showNotification('Tizim tayyor!', 'success', 2000);
        });

        // Klaviatura navigatsiyasi
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const activeForm = document.querySelector('div:not(.hidden)');
                if (activeForm && activeForm.id === 'loginForm') {
                    performLogin();
                } else if (activeForm && activeForm.id === 'registerForm') {
                    performRegister();
                }
            }
            
            if (e.key === 'Escape') {
                closeFaceDetection();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97c46e8654433536',t:'MTc1NzM5NzI3NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>