<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Identifikatsiya Tizimi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .input-focus:focus {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .oval-frame {
            width: 300px;
            height: 400px;
            border: 4px solid #10b981;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
        }
        .oval-frame.detecting {
            border-color: #f59e0b;
            animation: pulse 1s infinite;
        }
        .oval-frame.valid {
            border-color: #10b981;
            animation: validPulse 0.5s ease-out;
        }
        .oval-frame.invalid {
            border-color: #ef4444;
            animation: shake 0.5s ease-out;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.02); opacity: 0.8; }
        }
        @keyframes validPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .status-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            min-width: 250px;
        }
        .notification {
            animation: slideInRight 0.3s ease-out;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .error-field {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 1px #ef4444 !important;
        }
        .fullscreen-camera {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .face-detection-info {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            min-width: 300px;
        }
        .progress-bar {
            width: 200px;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px auto;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #34d399);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <!-- Status Panel -->
    <div id="statusPanel" class="status-panel">
        <!-- Notifications will appear here -->
    </div>

    <!-- Fullscreen Camera Modal -->
    <div id="fullscreenCamera" class="fullscreen-camera hidden">
        <div class="face-detection-info">
            <h3 class="text-lg font-semibold mb-2" id="detectionTitle">Yuz tanish</h3>
            <p class="text-sm mb-3" id="detectionMessage">Yuzingizni oval ichiga joylashtiring</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p class="text-xs text-gray-300" id="detectionStatus">Jonli yuz kutilmoqda...</p>
        </div>
        
        <div class="relative">
            <video id="fullscreenVideo" class="rounded-2xl" width="640" height="480" autoplay muted></video>
            <div class="absolute inset-0 flex items-center justify-center">
                <div class="oval-frame" id="faceFrame"></div>
            </div>
        </div>
        
        <button onclick="closeFaceDetection()" class="mt-6 bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300">
            Bekor qilish
        </button>
    </div>

    <!-- Voice Recognition Modal -->
    <div id="voiceModal" class="fullscreen-camera hidden">
        <div class="face-detection-info">
            <h3 class="text-lg font-semibold mb-2" id="voiceTitle">Ovoz tanish</h3>
            <p class="text-sm mb-3" id="voiceMessage">Mikrofonga gapiring</p>
            <div class="progress-bar">
                <div class="progress-fill" id="voiceProgressFill"></div>
            </div>
            <p class="text-xs text-gray-300" id="voiceStatus">Ovoz kutilmoqda...</p>
        </div>
        
        <div class="relative flex flex-col items-center">
            <!-- Mikrofon animatsiyasi -->
            <div class="w-32 h-32 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center mb-6" id="microphoneIcon">
                <svg class="w-16 h-16 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                </svg>
            </div>
            
            <!-- Ovoz ko'rsatkichi -->
            <div class="w-64 h-2 bg-gray-700 rounded-full mb-4">
                <div class="h-full bg-gradient-to-r from-green-400 to-blue-500 rounded-full transition-all duration-100" id="voiceLevel" style="width: 0%"></div>
            </div>
            
            <!-- Tanilgan matn -->
            <div class="bg-black/50 rounded-lg p-4 min-h-16 w-80 text-center">
                <p class="text-white text-sm" id="recognizedText">Gapiring...</p>
            </div>
        </div>
        
        <div class="flex space-x-4 mt-6">
            <button onclick="startVoiceRecording()" id="voiceStartBtn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300">
                Boshlash
            </button>
            <button onclick="closeVoiceModal()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300">
                Bekor qilish
            </button>
        </div>
    </div>

    <div class="w-full max-w-md">
        <!-- Kirish Oynasi -->
        <div id="loginForm" class="glass-effect rounded-2xl p-8 shadow-2xl slide-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">Xush kelibsiz</h2>
                <p class="text-white/80">Hisobingizga kiring</p>
            </div>

            <form class="space-y-6">
                <div>
                    <label class="block text-white/90 text-sm font-medium mb-2">Email yoki telefon</label>
                    <input type="text" id="loginEmail" class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 input-focus transition-all duration-300" placeholder="email@example.com">
                </div>
                
                <div>
                    <label class="block text-white/90 text-sm font-medium mb-2">Parol</label>
                    <div class="relative">
                        <input type="password" id="loginPassword" class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 input-focus transition-all duration-300" placeholder="••••••••">
                        <button type="button" onclick="togglePassword('loginPassword')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-white/60 hover:text-white transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <label class="flex items-center">
                        <input type="checkbox" class="w-4 h-4 text-indigo-600 bg-white/20 border-white/30 rounded focus:ring-white/50">
                        <span class="ml-2 text-white/80 text-sm">Eslab qolish</span>
                    </label>
                    <button type="button" class="text-white/80 hover:text-white text-sm transition-colors">Parolni unutdingizmi?</button>
                </div>

                <button type="button" onclick="performLogin()" class="w-full bg-white text-indigo-600 py-3 px-4 rounded-xl font-semibold hover:bg-white/90 transform hover:scale-105 transition-all duration-300 shadow-lg">
                    Kirish
                </button>
            </form>

            <div class="mt-6">
                <div class="relative">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-white/30"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-transparent text-white/80">yoki</span>
                    </div>
                </div>

                <button type="button" onclick="startFaceLogin()" id="faceLoginBtn" class="w-full mt-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 px-4 rounded-xl font-semibold hover:from-purple-600 hover:to-pink-600 transform hover:scale-105 transition-all duration-300 shadow-lg flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                    <span>Yuz orqali kirish</span>
                </button>

                <button type="button" onclick="startVoiceLogin()" id="voiceLoginBtn" class="w-full mt-3 bg-gradient-to-r from-blue-500 to-cyan-500 text-white py-3 px-4 rounded-xl font-semibold hover:from-blue-600 hover:to-cyan-600 transform hover:scale-105 transition-all duration-300 shadow-lg flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                    </svg>
                    <span>Ovoz orqali kirish</span>
                </button>
            </div>

            <div class="mt-6 text-center">
                <p class="text-white/80">Hisobingiz yo'qmi? 
                    <button onclick="showRegister()" class="text-white font-semibold hover:underline">Ro'yxatdan o'ting</button>
                </p>
                
                <div class="mt-4 pt-4 border-t border-white/20 space-y-2">
                    <button onclick="toggleAccessibilityMode()" class="text-white/60 hover:text-white text-xs transition-colors flex items-center justify-center space-x-1 mx-auto">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>Maxsus imkoniyatlar</span>
                    </button>
                    
                    <button onclick="showSecuritySettings()" class="text-white/60 hover:text-white text-xs transition-colors flex items-center justify-center space-x-1 mx-auto">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                        <span>Xavfsizlik sozlamalari</span>
                    </button>
                    
                    <button onclick="showSystemInfo()" class="text-white/60 hover:text-white text-xs transition-colors flex items-center justify-center space-x-1 mx-auto">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>Tizim ma'lumotlari</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Ro'yxatdan o'tish oynasi -->
        <div id="registerForm" class="glass-effect rounded-2xl p-8 shadow-2xl slide-in hidden">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">Ro'yxatdan o'tish</h2>
                <p class="text-white/80">Yangi hisob yarating</p>
            </div>

            <form class="space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-white/90 text-sm font-medium mb-2">Ism</label>
                        <input type="text" id="firstName" class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 input-focus transition-all duration-300" placeholder="Ismingiz">
                    </div>
                    <div>
                        <label class="block text-white/90 text-sm font-medium mb-2">Familiya</label>
                        <input type="text" id="lastName" class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 input-focus transition-all duration-300" placeholder="Familiyangiz">
                    </div>
                </div>

                <div>
                    <label class="block text-white/90 text-sm font-medium mb-2">Email</label>
                    <input type="email" id="registerEmail" class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 input-focus transition-all duration-300" placeholder="email@example.com">
                </div>

                <div>
                    <label class="block text-white/90 text-sm font-medium mb-2">Telefon raqam</label>
                    <input type="tel" id="phone" class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 input-focus transition-all duration-300" placeholder="+998 90 123 45 67">
                </div>

                <div>
                    <label class="block text-white/90 text-sm font-medium mb-2">Parol</label>
                    <div class="relative">
                        <input type="password" id="registerPassword" oninput="updatePasswordStrength()" class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 input-focus transition-all duration-300" placeholder="••••••••">
                        <button type="button" onclick="togglePassword('registerPassword')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-white/60 hover:text-white transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </div>
                    <!-- Parol kuchliligi ko'rsatkichi -->
                    <div class="mt-2">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-white/70 text-xs">Parol kuchliligi:</span>
                            <span id="passwordStrengthText" class="text-xs font-medium">-</span>
                        </div>
                        <div class="w-full bg-white/20 rounded-full h-2">
                            <div id="passwordStrengthBar" class="h-2 rounded-full transition-all duration-300" style="width: 0%; background-color: #ef4444;"></div>
                        </div>
                        <div id="passwordFeedback" class="text-xs text-white/60 mt-1 hidden"></div>
                    </div>
                </div>

                <div>
                    <label class="block text-white/90 text-sm font-medium mb-2">Parolni tasdiqlang</label>
                    <div class="relative">
                        <input type="password" id="confirmPassword" class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 input-focus transition-all duration-300" placeholder="••••••••">
                        <button type="button" onclick="togglePassword('confirmPassword')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-white/60 hover:text-white transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="flex items-center">
                    <input type="checkbox" id="terms" class="w-4 h-4 text-indigo-600 bg-white/20 border-white/30 rounded focus:ring-white/50">
                    <label for="terms" class="ml-2 text-white/80 text-sm">
                        <span>Men </span>
                        <button type="button" class="text-white font-semibold hover:underline">foydalanish shartlari</button>
                        <span> va </span>
                        <button type="button" class="text-white font-semibold hover:underline">maxfiylik siyosati</button>
                        <span>ga roziman</span>
                    </label>
                </div>

                <button type="button" onclick="performRegister()" class="w-full bg-white text-indigo-600 py-3 px-4 rounded-xl font-semibold hover:bg-white/90 transform hover:scale-105 transition-all duration-300 shadow-lg">
                    Ro'yxatdan o'tish
                </button>
            </form>

            <div class="mt-6">
                <div class="relative">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-white/30"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-transparent text-white/80">yoki</span>
                    </div>
                </div>

                <button type="button" onclick="startFaceRegistration()" id="faceRegisterBtn" class="w-full mt-4 bg-gradient-to-r from-green-500 to-teal-500 text-white py-3 px-4 rounded-xl font-semibold hover:from-green-600 hover:to-teal-600 transform hover:scale-105 transition-all duration-300 shadow-lg flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <span>Yuz orqali ro'yxatdan o'tish</span>
                </button>

                <button type="button" onclick="startVoiceRegistration()" id="voiceRegisterBtn" class="w-full mt-3 bg-gradient-to-r from-orange-500 to-red-500 text-white py-3 px-4 rounded-xl font-semibold hover:from-orange-600 hover:to-red-600 transform hover:scale-105 transition-all duration-300 shadow-lg flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                    </svg>
                    <span>Ovoz orqali ro'yxatdan o'tish</span>
                </button>
            </div>

            <div class="mt-6 text-center">
                <p class="text-white/80">Hisobingiz bormi? 
                    <button onclick="showLogin()" class="text-white font-semibold hover:underline">Kirish</button>
                </p>
            </div>
        </div>

        <!-- Muvaffaqiyat oynasi -->
        <div id="successForm" class="glass-effect rounded-2xl p-8 shadow-2xl slide-in hidden">
            <div class="text-center">
                <div class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-white mb-4">Muvaffaqiyatli!</h2>
                <p class="text-white/80 mb-8" id="successMessage">Hisobingiz muvaffaqiyatli yaratildi</p>
                
                <button onclick="showLogin()" class="w-full bg-white text-indigo-600 py-3 px-4 rounded-xl font-semibold hover:bg-white/90 transform hover:scale-105 transition-all duration-300 shadow-lg">
                    Hisobga kirish
                </button>
            </div>
        </div>
    </div>

    <script>
        let registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
        let currentStream = null;
        let faceDetectionInterval = null;
        let detectionProgress = 0;
        let isProcessing = false;
        let currentMode = 'register'; // 'register' or 'login'
        let voiceRecognitionActive = false;
        let speechRecognition = null;
        let voiceAttempts = 0;
        let isAccessibilityMode = false;
        
        // Yangi xavfsizlik o'zgaruvchilari
        let loginAttempts = JSON.parse(localStorage.getItem('loginAttempts') || '{}');
        let blockedUsers = JSON.parse(localStorage.getItem('blockedUsers') || '{}');
        let sessionData = JSON.parse(localStorage.getItem('sessionData') || '{}');
        let securityLogs = JSON.parse(localStorage.getItem('securityLogs') || '[]');
        let twoFactorEnabled = false;
        let currentUser = null;
        let deviceFingerprint = generateDeviceFingerprint();
        
        // Yangi UI o'zgaruvchilari
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        let currentLanguage = localStorage.getItem('language') || 'uz';
        let notificationSound = localStorage.getItem('notificationSound') !== 'false';
        let autoSave = localStorage.getItem('autoSave') !== 'false';
        
        // Ovoz effektlari
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Qurilma identifikatori yaratish
        function generateDeviceFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('Device fingerprint', 2, 2);
            
            const fingerprint = {
                screen: `${screen.width}x${screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                language: navigator.language,
                platform: navigator.platform,
                userAgent: navigator.userAgent.substring(0, 100),
                canvas: canvas.toDataURL().substring(0, 50),
                timestamp: Date.now()
            };
            
            return btoa(JSON.stringify(fingerprint)).substring(0, 32);
        }
        
        // Xavfsizlik logi qo'shish
        function addSecurityLog(action, details = {}) {
            const log = {
                id: Date.now(),
                action: action,
                timestamp: new Date().toISOString(),
                deviceFingerprint: deviceFingerprint,
                userAgent: navigator.userAgent.substring(0, 100),
                ip: 'localhost', // Haqiqiy dasturda server tomonidan aniqlanadi
                details: details
            };
            
            securityLogs.unshift(log);
            
            // Faqat oxirgi 100 ta logni saqlash
            if (securityLogs.length > 100) {
                securityLogs = securityLogs.slice(0, 100);
            }
            
            localStorage.setItem('securityLogs', JSON.stringify(securityLogs));
        }
        
        // Kirish urinishlarini kuzatish
        function trackLoginAttempt(identifier, success = false) {
            const now = Date.now();
            const key = identifier.toLowerCase();
            
            if (!loginAttempts[key]) {
                loginAttempts[key] = {
                    attempts: 0,
                    lastAttempt: now,
                    blocked: false,
                    blockUntil: 0
                };
            }
            
            const userAttempts = loginAttempts[key];
            
            if (success) {
                // Muvaffaqiyatli kirish - hisoblagichni tozalash
                delete loginAttempts[key];
                addSecurityLog('successful_login', { identifier: key });
            } else {
                // Muvaffaqiyatsiz kirish
                userAttempts.attempts++;
                userAttempts.lastAttempt = now;
                
                // 5 marta noto'g'ri urinishdan keyin 15 daqiqaga bloklash
                if (userAttempts.attempts >= 5) {
                    userAttempts.blocked = true;
                    userAttempts.blockUntil = now + (15 * 60 * 1000); // 15 daqiqa
                    
                    addSecurityLog('account_blocked', { 
                        identifier: key, 
                        attempts: userAttempts.attempts,
                        blockDuration: '15 minutes'
                    });
                } else {
                    addSecurityLog('failed_login', { 
                        identifier: key, 
                        attempts: userAttempts.attempts 
                    });
                }
            }
            
            localStorage.setItem('loginAttempts', JSON.stringify(loginAttempts));
        }
        
        // Foydalanuvchi bloklanganligini tekshirish
        function isUserBlocked(identifier) {
            const key = identifier.toLowerCase();
            const userAttempts = loginAttempts[key];
            
            if (!userAttempts || !userAttempts.blocked) {
                return false;
            }
            
            const now = Date.now();
            if (now > userAttempts.blockUntil) {
                // Blok muddati tugagan
                delete loginAttempts[key];
                localStorage.setItem('loginAttempts', JSON.stringify(loginAttempts));
                return false;
            }
            
            return true;
        }
        
        // Blok qolgan vaqtini hisoblash
        function getBlockTimeRemaining(identifier) {
            const key = identifier.toLowerCase();
            const userAttempts = loginAttempts[key];
            
            if (!userAttempts || !userAttempts.blocked) {
                return 0;
            }
            
            const now = Date.now();
            const remaining = userAttempts.blockUntil - now;
            
            return Math.max(0, Math.ceil(remaining / 1000 / 60)); // Daqiqalarda
        }
        
        // Parol kuchliligini tekshirish
        function checkPasswordStrength(password) {
            let score = 0;
            let feedback = [];
            
            if (password.length >= 8) score += 1;
            else feedback.push('Kamida 8 ta belgi');
            
            if (/[a-z]/.test(password)) score += 1;
            else feedback.push('Kichik harf');
            
            if (/[A-Z]/.test(password)) score += 1;
            else feedback.push('Katta harf');
            
            if (/[0-9]/.test(password)) score += 1;
            else feedback.push('Raqam');
            
            if (/[^a-zA-Z0-9]/.test(password)) score += 1;
            else feedback.push('Maxsus belgi');
            
            const strength = ['Juda zaif', 'Zaif', 'O\'rtacha', 'Kuchli', 'Juda kuchli'][score];
            const color = ['#ef4444', '#f59e0b', '#eab308', '#22c55e', '#16a34a'][score];
            
            return { score, strength, color, feedback };
        }
        
        // 2FA kod yaratish
        function generate2FACode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }
        
        // Email validatsiya (kengaytirilgan)
        function validateEmail(email) {
            const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
            
            if (!emailRegex.test(email)) {
                return { valid: false, message: 'Email formati noto\'g\'ri' };
            }
            
            // Taqiqlangan domenlar
            const blockedDomains = ['tempmail.com', '10minutemail.com', 'guerrillamail.com'];
            const domain = email.split('@')[1];
            
            if (blockedDomains.includes(domain)) {
                return { valid: false, message: 'Vaqtinchalik email manzillari taqiqlangan' };
            }
            
            return { valid: true, message: 'Email to\'g\'ri' };
        }
        
        // Telefon raqam validatsiya
        function validatePhone(phone) {
            const phoneRegex = /^\+998[0-9]{9}$/;
            const cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
            
            if (!phoneRegex.test(cleanPhone)) {
                return { valid: false, message: 'Telefon raqam formati: +998901234567' };
            }
            
            return { valid: true, message: 'Telefon raqam to\'g\'ri', cleanPhone };
        }
        
        function playSound(frequency, duration, type = 'success') {
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                if (type === 'success') {
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
                } else if (type === 'error') {
                    oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(300, audioContext.currentTime + 0.1);
                } else {
                    oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                }
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log('Audio not supported');
            }
        }
        
        // Qurilma tekshirish
        function isMobileDevice() {
            const userAgent = navigator.userAgent.toLowerCase();
            const isAndroid = userAgent.includes('android');
            const isIOS = userAgent.includes('iphone') || userAgent.includes('ipad') || userAgent.includes('ipod');
            return isAndroid || isIOS;
        }
        
        // Bildirishnoma ko'rsatish
        function showNotification(message, type = 'info', duration = 3000) {
            const panel = document.getElementById('statusPanel');
            const notification = document.createElement('div');
            
            let bgColor = 'bg-blue-500';
            let icon = '🔔';
            
            if (type === 'success') {
                bgColor = 'bg-green-500';
                icon = '✅';
                playSound(800, 0.2, 'success');
            } else if (type === 'error') {
                bgColor = 'bg-red-500';
                icon = '❌';
                playSound(400, 0.3, 'error');
            } else if (type === 'warning') {
                bgColor = 'bg-yellow-500';
                icon = '⚠️';
                playSound(600, 0.2, 'warning');
            }
            
            notification.className = `notification ${bgColor} text-white p-3 rounded-lg mb-2 shadow-lg flex items-center space-x-2`;
            notification.innerHTML = `
                <span class="text-lg">${icon}</span>
                <span class="text-sm">${message}</span>
            `;
            
            panel.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, duration);
        }
        
        // Maydon xatoligini ko'rsatish
        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            field.classList.add('error-field');
            showNotification(message, 'error');
            
            setTimeout(() => {
                field.classList.remove('error-field');
            }, 3000);
        }

        function showLogin() {
            hideAllForms();
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('loginForm').classList.add('fade-in');
        }

        function showRegister() {
            hideAllForms();
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('fade-in');
        }

        function showSuccess(message = 'Hisobingiz muvaffaqiyatli yaratildi') {
            hideAllForms();
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successForm').classList.remove('hidden');
            document.getElementById('successForm').classList.add('fade-in');
        }

        function hideAllForms() {
            const forms = ['loginForm', 'registerForm', 'successForm'];
            forms.forEach(formId => {
                document.getElementById(formId).classList.add('hidden');
                document.getElementById(formId).classList.remove('fade-in');
            });
            
            closeFaceDetection();
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function performLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showNotification('Barcha maydonlarni to\'ldiring!', 'error');
                return;
            }
            
            // Foydalanuvchi bloklanganligini tekshirish
            if (isUserBlocked(email)) {
                const remainingTime = getBlockTimeRemaining(email);
                showNotification(`Hisob ${remainingTime} daqiqaga bloklangan. Keyinroq urinib ko'ring.`, 'error');
                return;
            }
            
            // Foydalanuvchini tekshirish
            const user = registeredUsers.find(u => 
                (u.email === email || u.phone === email) && u.password === password
            );
            
            if (user) {
                // Muvaffaqiyatli kirish
                trackLoginAttempt(email, true);
                currentUser = user;
                
                // Session yaratish
                const sessionId = generateSessionId();
                sessionData[sessionId] = {
                    userId: user.id,
                    loginTime: new Date().toISOString(),
                    deviceFingerprint: deviceFingerprint,
                    lastActivity: new Date().toISOString()
                };
                localStorage.setItem('sessionData', JSON.stringify(sessionData));
                localStorage.setItem('currentSession', sessionId);
                
                showNotification(`Xush kelibsiz, ${user.firstName}!`, 'success');
                
                // 2FA tekshirish
                if (user.twoFactorEnabled) {
                    show2FAVerification(user);
                } else {
                    setTimeout(() => {
                        showSuccess(`Tizimga muvaffaqiyatli kirildi!\nXush kelibsiz, ${user.firstName} ${user.lastName}`);
                    }, 1000);
                }
            } else {
                // Muvaffaqiyatsiz kirish
                trackLoginAttempt(email, false);
                const attempts = loginAttempts[email.toLowerCase()]?.attempts || 0;
                const remaining = 5 - attempts;
                
                if (remaining > 0) {
                    showNotification(`Email/telefon yoki parol noto'g'ri! ${remaining} ta urinish qoldi.`, 'error');
                } else {
                    showNotification('Hisob 15 daqiqaga bloklandi!', 'error');
                }
            }
        }
        
        // Session ID yaratish
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substring(2);
        }
        
        // 2FA tekshirish oynasi
        function show2FAVerification(user) {
            const code = generate2FACode();
            
            // Demo maqsadida kodni konsolga chiqarish
            console.log('2FA kod (demo):', code);
            
            const modal = document.createElement('div');
            modal.className = 'fullscreen-camera';
            modal.innerHTML = `
                <div class="glass-effect rounded-2xl p-8 shadow-2xl max-w-md w-full mx-4">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-white mb-2">2FA Tasdiqlash</h3>
                        <p class="text-white/80">6 raqamli kodni kiriting</p>
                        <p class="text-yellow-300 text-sm mt-2">Demo kod: ${code}</p>
                    </div>
                    
                    <div class="space-y-4">
                        <input type="text" id="twoFactorCode" maxlength="6" class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-xl text-white text-center text-2xl tracking-widest placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="000000">
                        
                        <div class="flex space-x-3">
                            <button onclick="verify2FA('${code}', '${user.id}')" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 px-4 rounded-xl font-semibold transition-all duration-300">
                                Tasdiqlash
                            </button>
                            <button onclick="close2FAModal()" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 px-4 rounded-xl font-semibold transition-all duration-300">
                                Bekor qilish
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('twoFactorCode').focus();
        }
        
        // 2FA tasdiqlash
        function verify2FA(correctCode, userId) {
            const enteredCode = document.getElementById('twoFactorCode').value;
            
            if (enteredCode === correctCode) {
                close2FAModal();
                const user = registeredUsers.find(u => u.id == userId);
                showNotification('2FA tasdiqlandi!', 'success');
                setTimeout(() => {
                    showSuccess(`Tizimga muvaffaqiyatli kirildi!\nXush kelibsiz, ${user.firstName} ${user.lastName}`);
                }, 1000);
            } else {
                showNotification('Noto\'g\'ri kod!', 'error');
                document.getElementById('twoFactorCode').value = '';
                document.getElementById('twoFactorCode').focus();
            }
        }
        
        // 2FA modal yopish
        function close2FAModal() {
            const modal = document.querySelector('.fullscreen-camera:last-child');
            if (modal) {
                modal.remove();
            }
        }

        function performRegister() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const terms = document.getElementById('terms').checked;
            
            // Validatsiya
            if (!firstName) {
                showFieldError('firstName', 'Ism kiritilishi shart!');
                return;
            }
            
            if (!lastName) {
                showFieldError('lastName', 'Familiya kiritilishi shart!');
                return;
            }
            
            if (!email) {
                showFieldError('registerEmail', 'Email kiritilishi shart!');
                return;
            }
            
            // Kengaytirilgan email validatsiya
            const emailValidation = validateEmail(email);
            if (!emailValidation.valid) {
                showFieldError('registerEmail', emailValidation.message);
                return;
            }
            
            if (!phone) {
                showFieldError('phone', 'Telefon raqam kiritilishi shart!');
                return;
            }
            
            // Telefon raqam validatsiya
            const phoneValidation = validatePhone(phone);
            if (!phoneValidation.valid) {
                showFieldError('phone', phoneValidation.message);
                return;
            }
            
            if (!password) {
                showFieldError('registerPassword', 'Parol kiritilishi shart!');
                return;
            }
            
            // Parol kuchliligini tekshirish
            const passwordStrength = checkPasswordStrength(password);
            if (passwordStrength.score < 3) {
                showFieldError('registerPassword', `Parol juda zaif! Kerak: ${passwordStrength.feedback.join(', ')}`);
                return;
            }
            
            if (!confirmPassword) {
                showFieldError('confirmPassword', 'Parolni tasdiqlash shart!');
                return;
            }
            
            if (password !== confirmPassword) {
                showFieldError('confirmPassword', 'Parollar mos kelmaydi!');
                return;
            }
            
            if (!terms) {
                showNotification('Foydalanish shartlarini qabul qiling!', 'error');
                return;
            }
            
            // Email/telefon takrorlanishini tekshirish
            const existingUser = registeredUsers.find(u => 
                u.email === email || u.phone === phoneValidation.cleanPhone
            );
            if (existingUser) {
                if (existingUser.email === email) {
                    showFieldError('registerEmail', 'Bu email allaqachon ro\'yxatdan o\'tgan!');
                } else {
                    showFieldError('phone', 'Bu telefon raqam allaqachon ro\'yxatdan o\'tgan!');
                }
                return;
            }
            
            // Parolni hash qilish (soddalashtirilgan)
            const hashedPassword = btoa(password + 'salt_' + email);
            
            // Foydalanuvchini ro'yxatga qo'shish
            const newUser = {
                id: Date.now(),
                firstName,
                lastName,
                email,
                phone: phoneValidation.cleanPhone,
                password: hashedPassword,
                originalPassword: password, // Demo uchun
                registeredAt: new Date().toISOString(),
                hasFaceData: false,
                faceData: null,
                hasVoiceData: false,
                voiceData: null,
                twoFactorEnabled: false,
                deviceFingerprint: deviceFingerprint,
                lastLogin: null,
                loginCount: 0,
                isActive: true,
                emailVerified: false,
                phoneVerified: false
            };
            
            registeredUsers.push(newUser);
            localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
            
            // Xavfsizlik logi
            addSecurityLog('user_registered', {
                userId: newUser.id,
                email: email,
                phone: phoneValidation.cleanPhone
            });
            
            showNotification('Ma\'lumotlar saqlandi!', 'success');
            
            // Email tasdiqlash simulatsiyasi
            setTimeout(() => {
                showEmailVerification(newUser);
            }, 1000);
        }
        
        // Email tasdiqlash oynasi
        function showEmailVerification(user) {
            const verificationCode = Math.floor(1000 + Math.random() * 9000).toString();
            
            const modal = document.createElement('div');
            modal.className = 'fullscreen-camera';
            modal.innerHTML = `
                <div class="glass-effect rounded-2xl p-8 shadow-2xl max-w-md w-full mx-4">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-white mb-2">Email Tasdiqlash</h3>
                        <p class="text-white/80 mb-2">${user.email} manziliga kod yuborildi</p>
                        <p class="text-yellow-300 text-sm">Demo kod: ${verificationCode}</p>
                    </div>
                    
                    <div class="space-y-4">
                        <input type="text" id="emailVerificationCode" maxlength="4" class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-xl text-white text-center text-2xl tracking-widest placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="0000">
                        
                        <div class="flex space-x-3">
                            <button onclick="verifyEmail('${verificationCode}', '${user.id}')" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 px-4 rounded-xl font-semibold transition-all duration-300">
                                Tasdiqlash
                            </button>
                            <button onclick="skipEmailVerification('${user.id}')" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-4 rounded-xl font-semibold transition-all duration-300">
                                Keyinroq
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('emailVerificationCode').focus();
        }
        
        // Email tasdiqlash
        function verifyEmail(correctCode, userId) {
            const enteredCode = document.getElementById('emailVerificationCode').value;
            
            if (enteredCode === correctCode) {
                // Foydalanuvchini yangilash
                const userIndex = registeredUsers.findIndex(u => u.id == userId);
                if (userIndex !== -1) {
                    registeredUsers[userIndex].emailVerified = true;
                    localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
                }
                
                closeEmailVerificationModal();
                showNotification('Email tasdiqlandi!', 'success');
                showSuccess('Ro\'yxatdan o\'tish muvaffaqiyatli yakunlandi!\nEmail manzil tasdiqlandi.');
            } else {
                showNotification('Noto\'g\'ri kod!', 'error');
                document.getElementById('emailVerificationCode').value = '';
                document.getElementById('emailVerificationCode').focus();
            }
        }
        
        // Email tasdiqni o'tkazib yuborish
        function skipEmailVerification(userId) {
            closeEmailVerificationModal();
            showSuccess('Ro\'yxatdan o\'tish muvaffaqiyatli yakunlandi!\nEmail tasdiqni keyinroq amalga oshirishingiz mumkin.');
        }
        
        // Email tasdiqlash modal yopish
        function closeEmailVerificationModal() {
            const modal = document.querySelector('.fullscreen-camera:last-child');
            if (modal) {
                modal.remove();
            }
        }
        
        // Parol kuchliligini yangilash
        function updatePasswordStrength() {
            const password = document.getElementById('registerPassword').value;
            const strengthBar = document.getElementById('passwordStrengthBar');
            const strengthText = document.getElementById('passwordStrengthText');
            const feedback = document.getElementById('passwordFeedback');
            
            if (!password) {
                strengthBar.style.width = '0%';
                strengthText.textContent = '-';
                strengthText.style.color = '#ffffff';
                feedback.classList.add('hidden');
                return;
            }
            
            const strength = checkPasswordStrength(password);
            const percentage = (strength.score / 5) * 100;
            
            strengthBar.style.width = `${percentage}%`;
            strengthBar.style.backgroundColor = strength.color;
            strengthText.textContent = strength.strength;
            strengthText.style.color = strength.color;
            
            if (strength.feedback.length > 0) {
                feedback.textContent = `Kerak: ${strength.feedback.join(', ')}`;
                feedback.classList.remove('hidden');
            } else {
                feedback.classList.add('hidden');
            }
        }
        
        // Xavfsizlik sozlamalari oynasi
        function showSecuritySettings() {
            const modal = document.createElement('div');
            modal.className = 'fullscreen-camera';
            modal.innerHTML = `
                <div class="glass-effect rounded-2xl p-8 shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-white mb-2">Xavfsizlik Sozlamalari</h3>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Ro'yxatdan o'tgan foydalanuvchilar -->
                        <div class="bg-white/10 rounded-xl p-4">
                            <h4 class="text-white font-semibold mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                </svg>
                                Ro'yxatdan o'tgan foydalanuvchilar (${registeredUsers.length})
                            </h4>
                            <div class="space-y-2 max-h-40 overflow-y-auto">
                                ${registeredUsers.map(user => `
                                    <div class="bg-white/5 rounded-lg p-3 flex justify-between items-center">
                                        <div>
                                            <p class="text-white text-sm font-medium">${user.firstName} ${user.lastName}</p>
                                            <p class="text-white/60 text-xs">${user.email}</p>
                                            <div class="flex space-x-2 mt-1">
                                                ${user.emailVerified ? '<span class="text-green-400 text-xs">✓ Email</span>' : '<span class="text-red-400 text-xs">✗ Email</span>'}
                                                ${user.hasFaceData ? '<span class="text-green-400 text-xs">✓ Yuz</span>' : '<span class="text-gray-400 text-xs">✗ Yuz</span>'}
                                                ${user.hasVoiceData ? '<span class="text-green-400 text-xs">✓ Ovoz</span>' : '<span class="text-gray-400 text-xs">✗ Ovoz</span>'}
                                                ${user.twoFactorEnabled ? '<span class="text-blue-400 text-xs">✓ 2FA</span>' : '<span class="text-gray-400 text-xs">✗ 2FA</span>'}
                                            </div>
                                        </div>
                                        <button onclick="toggleUser2FA('${user.id}')" class="text-xs px-2 py-1 rounded ${user.twoFactorEnabled ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'} text-white transition-colors">
                                            ${user.twoFactorEnabled ? '2FA O\'chirish' : '2FA Yoqish'}
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Xavfsizlik loglari -->
                        <div class="bg-white/10 rounded-xl p-4">
                            <h4 class="text-white font-semibold mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Oxirgi xavfsizlik loglari (${securityLogs.length})
                            </h4>
                            <div class="space-y-2 max-h-40 overflow-y-auto">
                                ${securityLogs.slice(0, 10).map(log => `
                                    <div class="bg-white/5 rounded-lg p-2">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <p class="text-white text-xs font-medium">${getLogActionText(log.action)}</p>
                                                <p class="text-white/60 text-xs">${new Date(log.timestamp).toLocaleString('uz-UZ')}</p>
                                            </div>
                                            <span class="text-xs px-2 py-1 rounded ${getLogColor(log.action)}">${log.action}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Bloklangan foydalanuvchilar -->
                        <div class="bg-white/10 rounded-xl p-4">
                            <h4 class="text-white font-semibold mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18.364 5.636M5.636 18.364l12.728-12.728"></path>
                                </svg>
                                Bloklangan hisoblar
                            </h4>
                            <div class="space-y-2 max-h-32 overflow-y-auto">
                                ${Object.entries(loginAttempts).filter(([key, data]) => data.blocked).map(([key, data]) => `
                                    <div class="bg-red-500/20 rounded-lg p-2 flex justify-between items-center">
                                        <div>
                                            <p class="text-white text-xs">${key}</p>
                                            <p class="text-red-300 text-xs">${data.attempts} ta noto'g'ri urinish</p>
                                        </div>
                                        <button onclick="unblockUser('${key}')" class="text-xs px-2 py-1 bg-green-500 hover:bg-green-600 text-white rounded transition-colors">
                                            Blokni olib tashlash
                                        </button>
                                    </div>
                                `).join('') || '<p class="text-white/60 text-sm text-center py-4">Bloklangan hisoblar yo\'q</p>'}
                            </div>
                        </div>
                        
                        <!-- Tizim sozlamalari -->
                        <div class="bg-white/10 rounded-xl p-4">
                            <h4 class="text-white font-semibold mb-3">Tizim Sozlamalari</h4>
                            <div class="space-y-3">
                                <button onclick="clearAllData()" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg text-sm transition-colors">
                                    Barcha ma'lumotlarni tozalash
                                </button>
                                <button onclick="exportData()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg text-sm transition-colors">
                                    Ma'lumotlarni eksport qilish
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="closeSecuritySettings()" class="w-full mt-6 bg-gray-500 hover:bg-gray-600 text-white py-3 px-4 rounded-xl font-semibold transition-all duration-300">
                        Yopish
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Log matnini olish
        function getLogActionText(action) {
            const texts = {
                'successful_login': 'Muvaffaqiyatli kirish',
                'failed_login': 'Muvaffaqiyatsiz kirish',
                'account_blocked': 'Hisob bloklandi',
                'user_registered': 'Yangi foydalanuvchi ro\'yxatdan o\'tdi',
                'face_registered': 'Yuz ma\'lumotlari ro\'yxatga olindi',
                'voice_registered': 'Ovoz ma\'lumotlari ro\'yxatga olindi'
            };
            return texts[action] || action;
        }
        
        // Log rangini olish
        function getLogColor(action) {
            const colors = {
                'successful_login': 'bg-green-500/20 text-green-300',
                'failed_login': 'bg-red-500/20 text-red-300',
                'account_blocked': 'bg-red-600/20 text-red-400',
                'user_registered': 'bg-blue-500/20 text-blue-300',
                'face_registered': 'bg-purple-500/20 text-purple-300',
                'voice_registered': 'bg-orange-500/20 text-orange-300'
            };
            return colors[action] || 'bg-gray-500/20 text-gray-300';
        }
        
        // Foydalanuvchi 2FA ni yoqish/o'chirish
        function toggleUser2FA(userId) {
            const userIndex = registeredUsers.findIndex(u => u.id == userId);
            if (userIndex !== -1) {
                registeredUsers[userIndex].twoFactorEnabled = !registeredUsers[userIndex].twoFactorEnabled;
                localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
                
                const action = registeredUsers[userIndex].twoFactorEnabled ? 'yoqildi' : 'o\'chirildi';
                showNotification(`2FA ${action}!`, 'success');
                
                // Modal ni yangilash
                closeSecuritySettings();
                setTimeout(() => showSecuritySettings(), 100);
            }
        }
        
        // Foydalanuvchi blokini olib tashlash
        function unblockUser(identifier) {
            delete loginAttempts[identifier];
            localStorage.setItem('loginAttempts', JSON.stringify(loginAttempts));
            showNotification('Blok olib tashlandi!', 'success');
            
            // Modal ni yangilash
            closeSecuritySettings();
            setTimeout(() => showSecuritySettings(), 100);
        }
        
        // Barcha ma'lumotlarni tozalash
        function clearAllData() {
            if (confirm('Barcha ma\'lumotlar o\'chiriladi! Davom etasizmi?')) {
                localStorage.clear();
                registeredUsers = [];
                loginAttempts = {};
                securityLogs = [];
                sessionData = {};
                
                showNotification('Barcha ma\'lumotlar tozalandi!', 'success');
                closeSecuritySettings();
            }
        }
        
        // Ma'lumotlarni eksport qilish
        function exportData() {
            const data = {
                users: registeredUsers.map(u => ({
                    ...u,
                    password: '[HIDDEN]',
                    originalPassword: '[HIDDEN]',
                    faceData: u.faceData ? '[FACE_DATA]' : null,
                    voiceData: u.voiceData ? '[VOICE_DATA]' : null
                })),
                securityLogs: securityLogs,
                loginAttempts: loginAttempts,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `security_data_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Ma\'lumotlar eksport qilindi!', 'success');
        }
        
        // Xavfsizlik sozlamalari modal yopish
        function closeSecuritySettings() {
            const modal = document.querySelector('.fullscreen-camera:last-child');
            if (modal) {
                modal.remove();
            }
        }
        
        // Tizim ma'lumotlari oynasi
        function showSystemInfo() {
            const modal = document.createElement('div');
            modal.className = 'fullscreen-camera';
            modal.innerHTML = `
                <div class="glass-effect rounded-2xl p-8 shadow-2xl max-w-lg w-full mx-4">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-white mb-2">Tizim Ma'lumotlari</h3>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-white/10 rounded-xl p-4">
                            <h4 class="text-white font-semibold mb-3">Qurilma Ma'lumotlari</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-white/70">Brauzer:</span>
                                    <span class="text-white">${navigator.userAgent.split(' ')[0]}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-white/70">Platforma:</span>
                                    <span class="text-white">${navigator.platform}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-white/70">Til:</span>
                                    <span class="text-white">${navigator.language}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-white/70">Ekran:</span>
                                    <span class="text-white">${screen.width}x${screen.height}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-white/70">Vaqt zonasi:</span>
                                    <span class="text-white">${Intl.DateTimeFormat().resolvedOptions().timeZone}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-white/70">Qurilma ID:</span>
                                    <span class="text-white text-xs">${deviceFingerprint}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white/10 rounded-xl p-4">
                            <h4 class="text-white font-semibold mb-3">Tizim Statistikasi</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-white/70">Foydalanuvchilar:</span>
                                    <span class="text-white">${registeredUsers.length}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-white/70">Yuz ma'lumotlari:</span>
                                    <span class="text-white">${registeredUsers.filter(u => u.hasFaceData).length}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-white/70">Ovoz ma'lumotlari:</span>
                                    <span class="text-white">${registeredUsers.filter(u => u.hasVoiceData).length}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-white/70">2FA yoqilgan:</span>
                                    <span class="text-white">${registeredUsers.filter(u => u.twoFactorEnabled).length}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-white/70">Xavfsizlik loglari:</span>
                                    <span class="text-white">${securityLogs.length}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-white/70">Bloklangan hisoblar:</span>
                                    <span class="text-white">${Object.keys(loginAttempts).filter(key => loginAttempts[key].blocked).length}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white/10 rounded-xl p-4">
                            <h4 class="text-white font-semibold mb-3">Qo'llab-quvvatlash</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-white/70">Kamera:</span>
                                    <span class="text-white">${navigator.mediaDevices ? '✓ Qo\'llab-quvvatlanadi' : '✗ Qo\'llab-quvvatlanmaydi'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-white/70">Mikrofon:</span>
                                    <span class="text-white">${navigator.mediaDevices ? '✓ Qo\'llab-quvvatlanadi' : '✗ Qo\'llab-quvvatlanmaydi'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-white/70">Ovoz tanish:</span>
                                    <span class="text-white">${('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) ? '✓ Qo\'llab-quvvatlanadi' : '✗ Qo\'llab-quvvatlanmaydi'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-white/70">LocalStorage:</span>
                                    <span class="text-white">${localStorage ? '✓ Qo\'llab-quvvatlanadi' : '✗ Qo\'llab-quvvatlanmaydi'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="closeSystemInfo()" class="w-full mt-6 bg-gray-500 hover:bg-gray-600 text-white py-3 px-4 rounded-xl font-semibold transition-all duration-300">
                        Yopish
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Tizim ma'lumotlari modal yopish
        function closeSystemInfo() {
            const modal = document.querySelector('.fullscreen-camera:last-child');
            if (modal) {
                modal.remove();
            }
        }

        // Yuz ro'yxatga olish
        function startFaceRegistration() {
            if (!isMobileDevice()) {
                showNotification('Yuz tanish faqat Android va iOS qurilmalarda ishlaydi!', 'error');
                return;
            }
            
            currentMode = 'register';
            openFaceDetection('Yuz ro\'yxatga olish', 'Yuzingizni oval ichiga joylashtiring va harakatsiz turing');
        }

        // Yuz orqali kirish
        function startFaceLogin() {
            if (!isMobileDevice()) {
                showNotification('Yuz tanish faqat Android va iOS qurilmalarda ishlaydi!', 'error');
                return;
            }
            
            // Ro'yxatdan o'tgan foydalanuvchilar borligini tekshirish
            const usersWithFace = registeredUsers.filter(user => user.hasFaceData);
            if (usersWithFace.length === 0) {
                showNotification('Hech kim yuz orqali ro\'yxatdan o\'tmagan! Avval yuz orqali ro\'yxatdan o\'ting.', 'warning');
                return;
            }
            
            currentMode = 'login';
            openFaceDetection('Yuz orqali kirish', 'Ro\'yxatdan o\'tgan yuzingizni tanish uchun oval ichiga qarang');
        }

        async function openFaceDetection(title, message) {
            try {
                document.getElementById('detectionTitle').textContent = title;
                document.getElementById('detectionMessage').textContent = message;
                document.getElementById('fullscreenCamera').classList.remove('hidden');
                
                showNotification('Kamera yoqilmoqda...', 'info');
                
                currentStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 }, 
                        height: { ideal: 720 },
                        facingMode: 'user'
                    } 
                });
                
                const video = document.getElementById('fullscreenVideo');
                video.srcObject = currentStream;
                
                video.onloadedmetadata = () => {
                    video.play();
                    showNotification('Kamera yoqildi! Yuzingizni oval ichiga joylashtiring.', 'success');
                    startFaceDetection();
                };
                
            } catch (error) {
                console.error('Kamera xatosi:', error);
                showNotification('Kameraga kirish rad etildi!', 'error');
                closeFaceDetection();
            }
        }

        function closeFaceDetection() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            if (faceDetectionInterval) {
                clearInterval(faceDetectionInterval);
                faceDetectionInterval = null;
            }
            
            document.getElementById('fullscreenCamera').classList.add('hidden');
            detectionProgress = 0;
            isProcessing = false;
            
            // Progress bar reset
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('faceFrame').className = 'oval-frame';
        }

        function startFaceDetection() {
            const video = document.getElementById('fullscreenVideo');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const faceFrame = document.getElementById('faceFrame');
            const statusElement = document.getElementById('detectionStatus');
            const progressFill = document.getElementById('progressFill');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            faceDetectionInterval = setInterval(() => {
                if (isProcessing) return;
                
                // Jonli yuz tekshirish simulatsiyasi
                ctx.drawImage(video, 0, 0);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // Yuz mavjudligini tekshirish (soddalashtirilgan)
                const brightness = calculateBrightness(imageData);
                const hasMovement = detectMovement(imageData);
                const faceInFrame = detectFaceInFrame(imageData);
                
                if (brightness < 50) {
                    // Juda qorong'u
                    faceFrame.className = 'oval-frame invalid';
                    statusElement.textContent = 'Yoritish yetarli emas, yorug\'roq joyga o\'ting';
                    resetProgress();
                } else if (!faceInFrame) {
                    // Yuz topilmadi
                    faceFrame.className = 'oval-frame invalid';
                    statusElement.textContent = 'Yuz aniqlanmadi, oval ichiga qarang';
                    resetProgress();
                } else if (!hasMovement) {
                    // Harakatsiz (rasm bo'lishi mumkin)
                    faceFrame.className = 'oval-frame invalid';
                    statusElement.textContent = 'Jonli yuz aniqlanmadi, ko\'z qirping yoki bosh harakati qiling';
                    resetProgress();
                } else {
                    // Barcha shartlar bajarildi
                    faceFrame.className = 'oval-frame detecting';
                    statusElement.textContent = 'Jonli yuz aniqlandi, tekshirilmoqda...';
                    
                    detectionProgress += 10;
                    progressFill.style.width = `${Math.min(detectionProgress, 100)}%`;
                    
                    if (detectionProgress >= 100) {
                        // 3 soniya to'ldi
                        faceFrame.className = 'oval-frame valid';
                        statusElement.textContent = 'Muvaffaqiyatli! Qayta ishlanmoqda...';
                        isProcessing = true;
                        
                        setTimeout(() => {
                            processFaceData(canvas);
                        }, 500);
                    }
                }
            }, 300); // Har 300ms da tekshirish
        }

        function calculateBrightness(imageData) {
            let totalBrightness = 0;
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                totalBrightness += (r + g + b) / 3;
            }
            
            return totalBrightness / (data.length / 4);
        }

        let previousImageData = null;
        function detectMovement(imageData) {
            if (!previousImageData) {
                previousImageData = imageData;
                return false;
            }
            
            let diff = 0;
            const data = imageData.data;
            const prevData = previousImageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const currentPixel = (data[i] + data[i + 1] + data[i + 2]) / 3;
                const prevPixel = (prevData[i] + prevData[i + 1] + prevData[i + 2]) / 3;
                diff += Math.abs(currentPixel - prevPixel);
            }
            
            previousImageData = imageData;
            return diff > 1000; // Harakat chegarasi
        }

        function detectFaceInFrame(imageData) {
            // Soddalashtirilgan yuz aniqlash
            // Haqiqiy dasturda face-api.js yoki boshqa kutubxona ishlatiladi
            const data = imageData.data;
            const width = imageData.width;
            const height = imageData.height;
            
            // Markaziy qismda yuz rangidagi piksellarni qidirish
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) / 6;
            
            let skinPixels = 0;
            let totalPixels = 0;
            
            for (let y = centerY - radius; y < centerY + radius; y++) {
                for (let x = centerX - radius; x < centerX + radius; x++) {
                    if (x >= 0 && x < width && y >= 0 && y < height) {
                        const index = (y * width + x) * 4;
                        const r = data[index];
                        const g = data[index + 1];
                        const b = data[index + 2];
                        
                        // Teri rangini aniqlash (soddalashtirilgan)
                        if (r > 95 && g > 40 && b > 20 && 
                            Math.max(r, g, b) - Math.min(r, g, b) > 15 &&
                            Math.abs(r - g) > 15 && r > g && r > b) {
                            skinPixels++;
                        }
                        totalPixels++;
                    }
                }
            }
            
            return (skinPixels / totalPixels) > 0.3; // 30% dan ko'p teri rangi
        }

        function resetProgress() {
            detectionProgress = Math.max(0, detectionProgress - 5);
            document.getElementById('progressFill').style.width = `${detectionProgress}%`;
        }

        function processFaceData(canvas) {
            const faceData = canvas.toDataURL();
            
            if (currentMode === 'register') {
                // Yuz takrorlanishini tekshirish
                showNotification('Yuz ma\'lumotlari tekshirilmoqda...', 'info');
                
                setTimeout(() => {
                    // Yuz takrorlanish tekshiruvi (soddalashtirilgan)
                    const existingFaceUser = registeredUsers.find(user => 
                        user.hasFaceData && compareFaces(user.faceData, faceData)
                    );
                    
                    if (existingFaceUser) {
                        closeFaceDetection();
                        showNotification('Bu yuz allaqachon ro\'yxatdan o\'tgan!', 'error');
                        return;
                    }
                    
                    // Yangi foydalanuvchi yaratish
                    const newUser = {
                        id: Date.now(),
                        firstName: 'Yuz orqali',
                        lastName: 'Ro\'yxatdan o\'tgan',
                        email: `face_user_${Date.now()}@system.local`,
                        phone: `+998${Math.floor(Math.random() * 1000000000)}`,
                        password: 'face_auth_' + Date.now(),
                        registeredAt: new Date().toISOString(),
                        hasFaceData: true,
                        faceData: faceData
                    };
                    
                    registeredUsers.push(newUser);
                    localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
                    
                    closeFaceDetection();
                    showNotification('Yuz orqali ro\'yxatdan o\'tish muvaffaqiyatli!', 'success');
                    showSuccess('Yuz orqali ro\'yxatdan o\'tish muvaffaqiyatli yakunlandi!');
                }, 1000);
                
            } else {
                // Kirish
                showNotification('Yuz tanilmoqda...', 'info');
                
                setTimeout(() => {
                    // Yuzni solishtirish (demo maqsadida har doim muvaffaqiyatli)
                    const usersWithFace = registeredUsers.filter(user => user.hasFaceData);
                    
                    if (usersWithFace.length > 0) {
                        const recognizedUser = usersWithFace[0]; // Birinchi foydalanuvchini tanish
                        
                        closeFaceDetection();
                        showNotification(`Xush kelibsiz, ${recognizedUser.firstName}!`, 'success');
                        showSuccess(`Yuz orqali tizimga muvaffaqiyatli kirildi!\nXush kelibsiz, ${recognizedUser.firstName} ${recognizedUser.lastName}`);
                    } else {
                        closeFaceDetection();
                        showNotification('Yuz tanilmadi!', 'error');
                    }
                }, 1000);
            }
        }

        // Yuz solishtirish funksiyasi (soddalashtirilgan)
        function compareFaces(faceData1, faceData2) {
            // Haqiqiy dasturda face-api.js yoki boshqa kutubxona ishlatiladi
            // Bu yerda soddalashtirilgan solishtirish
            if (!faceData1 || !faceData2) return false;
            
            // Base64 ma'lumotlarning bir qismini solishtirish
            const sample1 = faceData1.substring(100, 200);
            const sample2 = faceData2.substring(100, 200);
            
            let similarity = 0;
            const minLength = Math.min(sample1.length, sample2.length);
            
            for (let i = 0; i < minLength; i++) {
                if (sample1[i] === sample2[i]) {
                    similarity++;
                }
            }
            
            const similarityPercentage = (similarity / minLength) * 100;
            return similarityPercentage > 85; // 85% o'xshashlik
        }

        // Ovoz tanish funksiyalari
        function startVoiceLogin() {
            const usersWithVoice = registeredUsers.filter(user => user.hasVoiceData);
            if (usersWithVoice.length === 0) {
                showNotification('Hech kim ovoz orqali ro\'yxatdan o\'tmagan! Avval ovoz orqali ro\'yxatdan o\'ting.', 'warning');
                return;
            }
            
            currentMode = 'login';
            openVoiceModal('Ovoz orqali kirish', 'Ro\'yxatdan o\'tgan ovozingiz bilan gapiring');
        }

        function startVoiceRegistration() {
            currentMode = 'register';
            openVoiceModal('Ovoz orqali ro\'yxatdan o\'tish', 'Ovozingizni ro\'yxatga olish uchun gapiring');
        }

        function openVoiceModal(title, message) {
            document.getElementById('voiceTitle').textContent = title;
            document.getElementById('voiceMessage').textContent = message;
            document.getElementById('voiceModal').classList.remove('hidden');
            
            // Speech Recognition API tekshiruvi
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showNotification('Ovoz tanish bu brauzerda qo\'llab-quvvatlanmaydi!', 'error');
                closeVoiceModal();
                return;
            }
            
            showNotification('Ovoz tanish tayyor. "Boshlash" tugmasini bosing.', 'info');
        }

        function closeVoiceModal() {
            if (speechRecognition) {
                speechRecognition.stop();
                speechRecognition = null;
            }
            
            document.getElementById('voiceModal').classList.add('hidden');
            voiceRecognitionActive = false;
            voiceAttempts = 0;
            
            // Reset UI
            document.getElementById('voiceProgressFill').style.width = '0%';
            document.getElementById('recognizedText').textContent = 'Gapiring...';
            document.getElementById('voiceLevel').style.width = '0%';
        }

        function startVoiceRecording() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            speechRecognition = new SpeechRecognition();
            
            speechRecognition.continuous = true;
            speechRecognition.interimResults = true;
            speechRecognition.lang = 'uz-UZ'; // O'zbek tili
            
            let voiceProgress = 0;
            let recognizedPhrase = '';
            
            document.getElementById('voiceStartBtn').style.display = 'none';
            document.getElementById('voiceStatus').textContent = 'Tinglayapman...';
            
            speechRecognition.onstart = function() {
                voiceRecognitionActive = true;
                showNotification('Ovoz yozish boshlandi!', 'success');
                
                // Mikrofon animatsiyasi
                const micIcon = document.getElementById('microphoneIcon');
                micIcon.style.animation = 'pulse 1s infinite';
            };
            
            speechRecognition.onresult = function(event) {
                let interimTranscript = '';
                let finalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                const displayText = finalTranscript || interimTranscript;
                document.getElementById('recognizedText').textContent = displayText || 'Gapiring...';
                
                if (finalTranscript) {
                    recognizedPhrase = finalTranscript.trim().toLowerCase();
                    voiceProgress += 20;
                    document.getElementById('voiceProgressFill').style.width = `${Math.min(voiceProgress, 100)}%`;
                    
                    if (voiceProgress >= 100) {
                        processVoiceData(recognizedPhrase);
                    }
                }
                
                // Ovoz darajasi simulatsiyasi
                const randomLevel = Math.random() * 100;
                document.getElementById('voiceLevel').style.width = `${randomLevel}%`;
            };
            
            speechRecognition.onerror = function(event) {
                console.error('Ovoz tanish xatosi:', event.error);
                showNotification('Ovoz tanishda xatolik yuz berdi!', 'error');
                closeVoiceModal();
            };
            
            speechRecognition.onend = function() {
                if (voiceRecognitionActive && voiceProgress < 100) {
                    // Qayta boshlash
                    setTimeout(() => {
                        if (voiceRecognitionActive) {
                            speechRecognition.start();
                        }
                    }, 100);
                }
            };
            
            speechRecognition.start();
        }

        function processVoiceData(voicePhrase) {
            if (currentMode === 'register') {
                // Ovoz takrorlanishini tekshirish
                showNotification('Ovoz ma\'lumotlari tekshirilmoqda...', 'info');
                
                setTimeout(() => {
                    const existingVoiceUser = registeredUsers.find(user => 
                        user.hasVoiceData && compareVoices(user.voiceData, voicePhrase)
                    );
                    
                    if (existingVoiceUser) {
                        closeVoiceModal();
                        showNotification('Bu ovoz allaqachon ro\'yxatdan o\'tgan!', 'error');
                        return;
                    }
                    
                    // Yangi foydalanuvchi yaratish
                    const newUser = {
                        id: Date.now(),
                        firstName: 'Ovoz orqali',
                        lastName: 'Ro\'yxatdan o\'tgan',
                        email: `voice_user_${Date.now()}@system.local`,
                        phone: `+998${Math.floor(Math.random() * 1000000000)}`,
                        password: 'voice_auth_' + Date.now(),
                        registeredAt: new Date().toISOString(),
                        hasVoiceData: true,
                        voiceData: voicePhrase
                    };
                    
                    registeredUsers.push(newUser);
                    localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
                    
                    closeVoiceModal();
                    showNotification('Ovoz orqali ro\'yxatdan o\'tish muvaffaqiyatli!', 'success');
                    showSuccess('Ovoz orqali ro\'yxatdan o\'tish muvaffaqiyatli yakunlandi!');
                }, 1000);
                
            } else {
                // Kirish
                showNotification('Ovoz tanilmoqda...', 'info');
                
                setTimeout(() => {
                    const usersWithVoice = registeredUsers.filter(user => user.hasVoiceData);
                    const recognizedUser = usersWithVoice.find(user => 
                        compareVoices(user.voiceData, voicePhrase)
                    );
                    
                    if (recognizedUser) {
                        closeVoiceModal();
                        showNotification(`Xush kelibsiz, ${recognizedUser.firstName}!`, 'success');
                        showSuccess(`Ovoz orqali tizimga muvaffaqiyatli kirildi!\nXush kelibsiz, ${recognizedUser.firstName} ${recognizedUser.lastName}`);
                    } else {
                        closeVoiceModal();
                        showNotification('Ovoz tanilmadi!', 'error');
                    }
                }, 1000);
            }
        }

        function compareVoices(voiceData1, voiceData2) {
            // Soddalashtirilgan ovoz solishtirish
            if (!voiceData1 || !voiceData2) return false;
            
            const words1 = voiceData1.toLowerCase().split(' ');
            const words2 = voiceData2.toLowerCase().split(' ');
            
            let matchingWords = 0;
            const totalWords = Math.max(words1.length, words2.length);
            
            words1.forEach(word => {
                if (words2.includes(word)) {
                    matchingWords++;
                }
            });
            
            const similarity = (matchingWords / totalWords) * 100;
            return similarity > 60; // 60% o'xshashlik
        }

        // Sahifa yuklanganda
        document.addEventListener('DOMContentLoaded', function() {
            // Mobil qurilma emasligini tekshirish
            if (!isMobileDevice()) {
                const faceLoginBtn = document.getElementById('faceLoginBtn');
                const faceRegisterBtn = document.getElementById('faceRegisterBtn');
                
                if (faceLoginBtn) {
                    faceLoginBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    faceLoginBtn.title = 'Faqat Android va iOS qurilmalarda ishlaydi';
                }
                
                if (faceRegisterBtn) {
                    faceRegisterBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    faceRegisterBtn.title = 'Faqat Android va iOS qurilmalarda ishlaydi';
                }
            }
            
            // Ovoz tanish qo'llab-quvvatlashini tekshirish
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                const voiceLoginBtn = document.getElementById('voiceLoginBtn');
                const voiceRegisterBtn = document.getElementById('voiceRegisterBtn');
                
                if (voiceLoginBtn) {
                    voiceLoginBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    voiceLoginBtn.title = 'Ovoz tanish bu brauzerda qo\'llab-quvvatlanmaydi';
                }
                
                if (voiceRegisterBtn) {
                    voiceRegisterBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    voiceRegisterBtn.title = 'Ovoz tanish bu brauzerda qo\'llab-quvvatlanmaydi';
                }
            }
            
            // Xavfsizlik logi qo'shish
            addSecurityLog('system_started', {
                userAgent: navigator.userAgent.substring(0, 100),
                screen: `${screen.width}x${screen.height}`,
                language: navigator.language
            });
            
            // Eski sessionlarni tozalash (24 soatdan eski)
            cleanOldSessions();
            
            // Eski login urinishlarini tozalash (7 kundan eski)
            cleanOldLoginAttempts();
            
            // Xush kelibsiz xabari
            const totalUsers = registeredUsers.length;
            const activeUsers = registeredUsers.filter(u => u.isActive).length;
            const blockedAccounts = Object.keys(loginAttempts).filter(key => loginAttempts[key].blocked).length;
            
            let welcomeMessage = 'Xavfsiz identifikatsiya tizimi tayyor!';
            if (totalUsers > 0) {
                welcomeMessage += ` ${totalUsers} foydalanuvchi ro'yxatdan o'tgan.`;
            }
            if (blockedAccounts > 0) {
                welcomeMessage += ` ${blockedAccounts} hisob bloklangan.`;
            }
            
            showNotification(welcomeMessage, 'success', 4000);
        });
        
        // Eski sessionlarni tozalash
        function cleanOldSessions() {
            const now = Date.now();
            const dayInMs = 24 * 60 * 60 * 1000; // 24 soat
            
            Object.keys(sessionData).forEach(sessionId => {
                const session = sessionData[sessionId];
                const sessionTime = new Date(session.loginTime).getTime();
                
                if (now - sessionTime > dayInMs) {
                    delete sessionData[sessionId];
                }
            });
            
            localStorage.setItem('sessionData', JSON.stringify(sessionData));
        }
        
        // Eski login urinishlarini tozalash
        function cleanOldLoginAttempts() {
            const now = Date.now();
            const weekInMs = 7 * 24 * 60 * 60 * 1000; // 7 kun
            
            Object.keys(loginAttempts).forEach(key => {
                const attempt = loginAttempts[key];
                
                if (now - attempt.lastAttempt > weekInMs) {
                    delete loginAttempts[key];
                }
            });
            
            localStorage.setItem('loginAttempts', JSON.stringify(loginAttempts));
        }

        // Accessibility funksiyasi
        function toggleAccessibilityMode() {
            isAccessibilityMode = !isAccessibilityMode;
            
            if (isAccessibilityMode) {
                showNotification('Maxsus imkoniyatlar yoqildi! Ovoz buyruqlari faol.', 'success');
                document.body.style.fontSize = '18px';
                document.body.style.lineHeight = '1.6';
                
                // Ovoz buyruqlarini tinglash
                startVoiceCommands();
            } else {
                showNotification('Maxsus imkoniyatlar o\'chirildi.', 'info');
                document.body.style.fontSize = '';
                document.body.style.lineHeight = '';
                
                if (speechRecognition) {
                    speechRecognition.stop();
                }
            }
        }

        function startVoiceCommands() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showNotification('Ovoz buyruqlari bu brauzerda qo\'llab-quvvatlanmaydi!', 'error');
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const commandRecognition = new SpeechRecognition();
            
            commandRecognition.continuous = true;
            commandRecognition.interimResults = false;
            commandRecognition.lang = 'uz-UZ';
            
            commandRecognition.onresult = function(event) {
                const command = event.results[event.results.length - 1][0].transcript.toLowerCase().trim();
                
                // Ovoz buyruqlarini qayta ishlash
                if (command.includes('kirish') || command.includes('login')) {
                    showNotification('Kirish sahifasi ochilmoqda...', 'info');
                    showLogin();
                } else if (command.includes('ro\'yxat') || command.includes('register')) {
                    showNotification('Ro\'yxatdan o\'tish sahifasi ochilmoqda...', 'info');
                    showRegister();
                } else if (command.includes('yuz') && command.includes('kirish')) {
                    showNotification('Yuz orqali kirish boshlandi...', 'info');
                    startFaceLogin();
                } else if (command.includes('ovoz') && command.includes('kirish')) {
                    showNotification('Ovoz orqali kirish boshlandi...', 'info');
                    startVoiceLogin();
                } else if (command.includes('yuz') && command.includes('ro\'yxat')) {
                    showNotification('Yuz orqali ro\'yxatdan o\'tish boshlandi...', 'info');
                    startFaceRegistration();
                } else if (command.includes('ovoz') && command.includes('ro\'yxat')) {
                    showNotification('Ovoz orqali ro\'yxatdan o\'tish boshlandi...', 'info');
                    startVoiceRegistration();
                } else if (command.includes('yordam') || command.includes('help')) {
                    showNotification('Mavjud buyruqlar: "kirish", "ro\'yxat", "yuz kirish", "ovoz kirish"', 'info', 5000);
                }
            };
            
            commandRecognition.onerror = function(event) {
                console.log('Ovoz buyruq xatosi:', event.error);
            };
            
            commandRecognition.start();
        }

        // Klaviatura navigatsiyasi
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const activeForm = document.querySelector('div:not(.hidden)');
                if (activeForm && activeForm.id === 'loginForm') {
                    performLogin();
                } else if (activeForm && activeForm.id === 'registerForm') {
                    performRegister();
                }
            }
            
            if (e.key === 'Escape') {
                closeFaceDetection();
                closeVoiceModal();
            }
            
            // Accessibility klaviatura yorliqlari
            if (e.altKey && e.key === 'a') {
                toggleAccessibilityMode();
            }
            
            if (e.altKey && e.key === 'v') {
                if (isAccessibilityMode) {
                    startVoiceLogin();
                }
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97c48d5661c9027d',t:'MTc1NzM5ODUzNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>